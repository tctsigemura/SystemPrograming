\documentclass[a4j,twcolumn,11pt,nomag]{ltjarticle}      % lualatex の場合
\usepackage{myAns}
\chead{\textgt{システムプログラミング２　課題 No.2 解答}}

\begin{document}
\onecolumn
\section*{課題 No.2 の解答例}

高水準I/Oを使用した場合，
バッファサイズの異なる低水準I/Oを使用した場合について，
ファイルをコピーする時間を比較した．

\subsection*{実行条件}
  \begin{center}
    \begin{tabular}{l c l}
      実行したコンピュータ & ： & Mac mini M1 2020 \\
      実行コンピュータのOS & ： & macOS Ventura 13.3.1 \\
      ファイルサイズ      & ： & 5MiB(bs=1024, count=5120) \\
    \end{tabular}  
  \end{center}  

\subsection*{実行結果}
実行時間は遅い方から以下の順であった．
\begin{enumerate}
\item 1バイトのwriteシステムコール(mycp2\_1)
  \begin{center}
    \begin{tabular}{|l | r | r | r | r |} \hline
      & \multicolumn{1}{|c|}{1回目}
      & \multicolumn{1}{|c|}{2回目}
      & \multicolumn{1}{|c|}{3回目}
      & \multicolumn{1}{|c|}{平均} \\\hline\hline
      real & 19.93 & 19.90 & 19.76 & 19.86 \\\hline
      user &  2.31 &  2.33 &  2.31 &  2.32 \\\hline
      sys  & 17.56 & 17.49 & 17.40 & 17.48 \\\hline
    \end{tabular}
  \end{center}
\item 高水準I/O(mycp)
  \begin{center}
    \begin{tabular}{|l | r | r | r | r |} \hline
      & \multicolumn{1}{|c|}{1回目}
      & \multicolumn{1}{|c|}{2回目}
      & \multicolumn{1}{|c|}{3回目}
      & \multicolumn{1}{|c|}{平均} \\\hline\hline
      real & 0.39 & 0.38 & 0.38 & 0.38 \\\hline
      user & 0.37 & 0.37 & 0.37 & 0.37 \\\hline
      sys  & 0.01 & 0.01 & 0.01 & 0.01 \\\hline
    \end{tabular}
  \end{center}
\item 1,024バイトのwriteシステムコール(mycp2\_1024)
  \begin{center}
    \begin{tabular}{|l | r | r | r | r |} \hline
      & \multicolumn{1}{|c|}{1回目}
      & \multicolumn{1}{|c|}{2回目}
      & \multicolumn{1}{|c|}{3回目}
      & \multicolumn{1}{|c|}{平均} \\\hline\hline
      real & 0.04 & 0.04 & 0.04 & 0.04 \\\hline
      user & 0.00 & 0.00 & 0.00 & 0.00 \\\hline
      sys  & 0.03 & 0.03 & 0.03 & 0.03 \\\hline
    \end{tabular}
  \end{center}
\end{enumerate}
\subsection*{考察}
\begin{enumerate}
  \item mycp2\_1とmycp2\_1024の比較
  \begin{itemize}
   \item システム時間 \\
   mycp2\_1はmycp2\_1024よりシステム時間が約600倍になっている．
   システム時間は，システムコールの処理のためにカーネルが費やした時間である．
   ２つのプログラムで\|open()|，\|close()|システムコールの使い方は同じなので，
   変化は\|read()|，\|write()|システムコールが原因だと考えられる．

   \|read()|，\|write()|
   システムコールの呼び出し回数はmycp\_1の方が約1000倍になっているはずなので，
   測定結果からシステムコール1回当たりの処理時間は0.6倍程度と考えられる．
   システムコール1回当たり読み書きするデータの量が大きく変化（1000倍）しても，
   システムコール1回当たりの処理時間はあまり（1.7倍程度）変化しない．

   \item ユーザ時間 \\
   mycp2\_1024ではユーザ時間が短すぎて測定できなかった．
   mycp2\_1ではループを実行する回数が約1000倍なので，
   while文の実行，\|read()|，\|write()|が
   システムコールを発行の準備に費やす時間など，
   ユーザプログラム内で費やす時間が長くなったと考えられる．
   その結果，ユーザ時間が測定できたと考えられる．
  \end{itemize}

  \item mycpとmycp2\_1024の比較
  \begin{itemize}
   \item システム時間 \\
   mycpはmycp2\_1024と比較してシステム時間が短くなっている．
   mycpのシステムコール発行回数はmycp2\_1024より少ないと推察できる．
   このことから高水準I/Oが用いるバッファは1024バイトより大きく，
   mycpのシステムコール呼び出し回数を
   mycp2\_1024より少なくしていると考えられる。

   \item ユーザ時間 \\
   mycpもループの実行回数が多いためwhile文や\|getc()|，
   \|putc()|の実行回数が多く，
   計測できる程度のユーザ時間を費やしたと考えられる．
   \|getc()|，\|putc()|は
   FILE構造体のバッファを操作する処理を1バイト毎に行っており，
   この処理時間がユーザ時間に算入される．
  \end{itemize}

 \item mycpとmycp2\_1の比較
 \begin{itemize}
   \item システム時間 \\
   システム時間は高水準I/Oを用いるmycpの方が圧倒的に短い．
   FILE構造体のバッファにデータをためて
   システムコール回数を少なくしたお陰である．

  \item ユーザ時間 \\
  mycpはmycp2\_1と比較してユーザ時間がおおよそ6分の1倍になっている．
   \|read()|，\|write()|の呼出し回数と
   \|getc()|，\|putc()|の呼出し回数は同じはずである．
   \|getc()|，\|putc()|は，
   \|read()|，\|write()|関数中のシステムコールを呼び出す前処理
   （前処理までがuser時間に含まれる）より軽い．
   （これには驚いた．）
   macOSのオンラインマニュアル(\|$ man getc|)で調べてみると
   「\|getc()|はマクロでありインラインに展開される」と書いてある．
   \|getc()|，\|putc()|が，FILE構造体のバッファを操作する処理には
   高速化するための工夫が凝らされている．
 \end{itemize}

\end{enumerate}
\end{document}
