\documentclass[a4j,dvipdfmx]{jarticle}
%----------------------------------------------------------------------
\usepackage{graphicx}
%\usepackage{amsmath}
%\usepackage{amssymb}
%\usepackage{bm}
%\usepackage{fancybox}
\usepackage{fancyhdr}
\usepackage{lastpage}
%\usepackage{color}
\usepackage{multicol}
\usepackage{listings,jlisting}
%----------------------------------------------------------------------
\setlength{\topmargin}{-0.5in}
%\addtolength{\headheight}{1cm}
%%\setlength{\headsep}{0mm}
%\setlength{\oddsidemargin}{-0.5in}
%%\setlength{\evensidemargin}{-0.5in}
%\addtolength{\textwidth}{1.5in}
\addtolength{\textheight}{1in}
%----------------------------------------------------------------------
%\setlength{\columnsep}{2zw}
%\setlength{\columnseprule}{0.4pt}
%----------------------------------------------------------------------
\pagestyle{fancy}
\lhead{2016/05/17}
\rhead{配布資料(\thepage / \pageref{LastPage})}
\cfoot{}
\chead{\textgt{システムプログラミング２　第１１回}}
%----------------------------------------------------------------------
\begin{document}
\def\lstlistingname{リスト}
\lstset{language=C,
  numbers=left,
  basicstyle={\small\ttfamily},
  columns=[l]{fullflexible},
  keepspaces=true,
  frame=shadowbox,
  commentstyle=\slshape
}
%----------------------------------------------------------------------

%\begin{figure}[hbtp]
%\begin{center}
%\includegraphics[height=2.5cm]{state.pdf}
%\caption{単語の長さをカウントするアルゴリズム}
%\end{center}
%\end{figure}

今回は、環境変数について学ぶ。
環境変数はシェルが管理する変数である。
変数とはいえC言語の変数とは全く別の仕組みである。
プログラムは実行時に環境変数にアクセスし値により動作を変えたりする。
例えば\verb/LANG/と言う名前の環境変数の値により
メッセージの言語を変更したりする。

\begin{enumerate}
\item 環境変数の例 \\
MacやUNIX(Linux,FreeBSD)でよく使用される環境変数の「名前」と「値」の例を示す。
\begin{lstlisting}[numbers=none]
SHELL=/bin/bash                 # 使用中のシェル
TERM=xterm-256color             # 使用中のターミナルエミュレータ
USER=sigemura                   # 現在のユーザ
PATH=:/usr/bin:/bin:/usr...     # シェルがコマンドを探すディレクトリ一覧
PWD=/Users/sigemura             # カレントディレクトリのパス
HOME=/Users/sigemura            # ユーザのホームディレクトリ
LANG=ja_JP.UTF-8                # ユーザが使用したい言語(ja_JP.UTF-8(日本語))
LC_TIME=C                       # ユーザが日時の表示に使用したい言語（C言語標準)
TZ=Japan                        # どの地域の時刻を使用するか(日本)
CLICOLOR=1                      # ls コマンド等がカラー出力する(yes)
\end{lstlisting}

\item 環境変数を変更した例 \\
例えば\verb/LC_TIME/環境変数は日時の表示に使用する言語を決める。
\verb/date/コマンドや、\verb/ls/コマンド等がこの環境変数の値により
日時の表示を変化させる。
\begin{lstlisting}[numbers=none]
$ printenv LC_TIME              # 環境変数 LC_TIME の値を確認する
C
$ date
Sun Jun 26 11:04:27 JST 2016
$ ls -l
-rw-r--r--  1 sigemura  staff    319 Jun 26 10:30 Makefile
$ LC_TIME=ja_JP.UTF-8            # 環境変数 LC_TIME に日本語を表す値をセットする
$ date
2016年 6月26日 日曜日 11時03分21秒 JST
$ ls -l
rw-r--r--  1 sigemura  staff    319  6 26 10:30 Makefile
$ LC_TIME=ru_RU.UTF-8            # 環境変数 LC_TIME にロシア語を表す値をセットする
$ date
воскресенье, 26 июня 2016 г. 11:03:33 (JST)
$ ls -l
-rw-r--r--  1 sigemura  staff    319 26 июн 10:30 Makefile
\end{lstlisting}
このようにプログラムの振る舞いを環境変数でコントロールすることができる。

\item ディレクトリの削除（{\tt rmdir}システムコール）\\
{\tt rmdir}コマンドは、このシステムコールを利用している。
空ではないディレクトリを削除することはできない。
\begin{lstlisting}[numbers=none]
書式：
         #include <unistd.h>
         int rmdir(char *path);
           path：削除するディレクトリ
           返り値：正常=0、エラー=-1

使用例：
         // ディレクトリの削除
         if (rmdir("newdir")<0) {  // "newdir" 削除
           perror("newdir");       // エラー原因表示
           exit(1);                // エラー終了
         }

\end{lstlisting}

\newpage

\item リンクの作成（{\tt link}システムコール）\\
{\tt ln}コマンドは、ハードリンクを作るとき、このシステムコールを利用している。

\begin{lstlisting}[numbers=none]
書式：
         #include <unistd.h>
         int link(char *oldpath, char *newpath);
           oldpath：もとの名前
           newpath：新しい名前
           返り値：正常=0、エラー=-1

使用例：
         // ハードリンクの作成
         if (link("a.txt", "b.txt")<0) { // リンク"b.txt"を作る
           perror("link");               // "a.txt"と"b.txt"のどちらが原因か不明なので
           exit(1);                      // エラー終了
         }

\end{lstlisting}

ファイルの移動（ファイル名の変更）に応用できる。
\begin{lstlisting}[numbers=none]
         unlink("b.txt");                // 念のため"b.txt"を消す（エラーは無視）
         if (link("a.txt", "b.txt")<0) { // リンク"b.txt"を作る
           ... エラー処理 ... 
         if (unlink("a.txt")<0) {        // リンク"a.txt"を消す。
           ... エラー処理 ... 

\end{lstlisting}

\item シンボリックリンクの作成（{\tt symlink}システムコール）\\
{\tt ln}コマンドは、シンボリックリンクを作るとき（{\tt -s}オプション使用時）、
このシステムコールを利用している。

\begin{lstlisting}[numbers=none]
書式：
         #include <unistd.h>
         int symlink(char *path, char *newpath);
           path：シンボリックリンクに書き込む内容
           newpath：新しい名前（シンボリックリンクの名前）
           返り値：正常=0、エラー=-1

使用例：
         // シンボリックリンクの作成
         if (symlink("a.txt", "b.txt")<0) { // リンク"b.txt"を作る
           perror("b.txt");                 // エラー原因は必ず"b.txt"
           exit(1);                         // エラー終了
         }

\end{lstlisting}

\item ファイルの移動（ファイル名の変更）（{\tt rename}システムコール）\\
{\tt mv}コマンドは、このシステムコールを利用している。

\begin{lstlisting}[numbers=none]
書式：
         #include <stdio.h>
         int rename(char *from, char *to);
           from：もとのファイル名（パス）
           to：移動後のファイル名（パス）
           返り値：正常=0、エラー=-1

使用例：
         // ファイルの移動
         if (rename("a.txt", "b.txt")<0) { // "a.txt" を "b.txt" に変更
           perror("rename");               // エラー原因がどっちのパスか不明
           exit(1);                        // エラー終了
         }

\end{lstlisting}

\newpage
\item ファイルモードの変更（{\tt chmod}、{\tt lchmod}システムコール）\\
{\tt chmod}コマンドは、このシステムコールを利用している。

\begin{lstlisting}[numbers=none]
書式：
         #include <sys/stat.h>
         int chmod(char *path, int mode);
         int lchmod(char *path, int mode);
           path：ファイル名（パス）
           mode：モード
           返り値：正常=0、エラー=-1
          （lchmodはシンボリックリンクを辿らない）

使用例：
         // ファイルモードの変更
         if (chmod("a.txt", 0644)<0) { // ファイル"a.txt"のモードを"rw-r--r--"に変更
           perror("a.txt");            // エラー原因を表示
           exit(1);                    // エラー終了
         }

\end{lstlisting}

\item シンボリックリンクの内容を読む（{\tt readlink}システムコール）\\
{\tt ls}コマンドは、このシステムコールを利用している。

\begin{lstlisting}[numbers=none]
書式：
         #include <unistd.h>
         int readlink(char *path, char *buf, int size);
           path：シンボリックリンクのパス
           buf：内容を読み出す領域（バッファ）
           size：領域（バッファ）のバイト単位のサイズ
           返り値：読みだした文字数、エラー=-1

使用例：
         // シンボリックリンクの読み出し
         char *name = "b.txt";
         char buf[100];
         int n = readlink(name, buf, 99); // シンボリックリンクの内容をbufに読み出す
         if (n<0) {                       // エラーチェック
           perror(name);                  // エラー原因を表示
           exit(1);                       // エラー終了
         }
         buf[n]='\0';                     // C言語型の文字列として完成させる
         printf("%s -> %s\n", name, buf); // ls -s 表示をまねて出力

\end{lstlisting}

\item 宿題

\begin{enumerate}
\item 簡易版UNIXコマンドの作成

UNIXコマンド、{\tt rm}、{\tt mkdir}、{\tt rmdir}、
{\tt ln}、{\tt mv}の中から３つ以上を選択する。
各コマンドについて
上記のシステムコールを使用して簡易版を作ってみる。
但し、使用方法のエラーチェック、システムコールのエラーチェックは行うこと。

また、自分が作った簡易版と本物の機能の違いを調べる。

(\verb/$ man 1 rm/ 等でマニュアルを参照できる）

\item {\tt rename}システムコールの必要性

UNIXは Simple is best の思想で作られてきた。
そのため、専用の機能を用意しなくても既存の機能を組み合わせて実現できる場合は
専用機能の追加はしないことが多い。
{\tt rename}システムコールの機能は{\tt link}、{\tt unlink}システムコールの
組み合わせでも実現できそうだが{\tt rename}システムコールが追加された。
なぜ追加されたか考えなさい。
\end{enumerate}
\end{enumerate}
\end{document}
